<!DOCTYPE html>
<html>
<head>
  <title>Live Map with Top Filters</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS + JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
    }
    #topPanel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: #0094CD;
      display: flex;
      align-items: center;
      padding: 0 1rem;
      gap: 1rem;
      z-index: 1000;
      box-sizing: border-box;
    }
    #topPanel input, #topPanel select {
      height: 36px;
      font-size: 14px;
      padding: 0 0.5rem;
      border-radius: 4px;
      border: none;
    }
    #mapWrapper {
      position: absolute;
      top: 70px;
      left: 0;
      width: 100%;
      bottom: 0;
    }
    #map { height: 100%; width: 100%; }

    /* Nearby results */
    #resultsPanel {
      position: fixed;
      top: 70px;
      left: 0;
      width: 300px;
      bottom: 0;
      overflow-y: auto;
      background: rgba(0, 148, 205, 0.9);
      color: white;
      padding: 1rem;
      font-size: 0.9rem;
      z-index: 1000;
    }
    .nearby-entry {
      padding: 0.3rem 0.3rem 0.8rem 0.3rem;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      color: white;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .nearby-entry:hover { background-color: rgba(255,255,255,0.2); }
    .name-distance { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; }
    .distance { font-weight: normal; font-size: 0.75rem; opacity: 0.8; }
    .company-name { font-size: 0.8rem; margin-top: 0.2rem; opacity: 0.9; }

    /* Cluster styling */
    .custom-cluster {
      background-color: #013b5c;
      color: white;
      border: 3px solid white;
      border-radius: 50%;
      text-align: center;
      font-weight: bold;
      line-height: 40px;
      font-size: 16px;
    }

    /* Letter markers */
    .letter-marker {
      background: #013b5c;
      border: 3px solid white;
      color: white;
      border-radius: 50%;
      text-align: center;
      font-weight: bold;
      line-height: 30px;
      font-size: 14px;
      width: 30px;
      height: 30px;
    }
    .letter-marker:hover { filter: drop-shadow(0 0 8px #00f); }
  </style>
</head>
<body>

  <div id="topPanel">
    <input type="text" id="searchInput" placeholder="Search Name" />
    <input type="text" id="locationInput" placeholder="Search Location" />
    <select id="typeFilter"><option value="">All Types</option></select>
    <input type="number" id="distanceFilter" min="1" max="1000" step="1" value="50" />
  </div>

  <div id="resultsPanel">
    <h3>Nearby Results</h3>
    <div id="nearbyList">Click a marker to see nearby entries.</div>
  </div>

  <div id="mapWrapper">
    <div id="map"></div>
  </div>

  <script>
    const map = L.map('map', { zoomControl: true }).setView([50.5, -95.0], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const sheetURL = 'https://docs.google.com/spreadsheets/d/17h6qtv7Kw3ejYyK0hv7XyTUQ1y7KP3wj_w-pG4yNfkM/export?format=csv&gid=1454020769';

    let allData = [];
    let markers = [];
    let selectedMarker = null;

    const markerCluster = L.markerClusterGroup({
      iconCreateFunction: function(cluster) {
        return L.divIcon({
          html: `<div class="custom-cluster">${cluster.getChildCount()}</div>`,
          className: 'custom-cluster',
          iconSize: L.point(40, 40)
        });
      }
    });
    map.addLayer(markerCluster);

    // Load CSV
    fetch(sheetURL)
      .then(r => r.text())
      .then(csv => {
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        allData = parsed.data;

        // Populate Type filter
        const typeSet = new Set();
        allData.forEach(row => { if(row['Type']) typeSet.add(row['Type']); });
        const typeSelect = document.getElementById('typeFilter');
        Array.from(typeSet).sort().forEach(type => {
          const opt = document.createElement('option');
          opt.value = type; opt.textContent = type;
          typeSelect.appendChild(opt);
        });

        updateMap();

        document.getElementById('typeFilter').addEventListener('change', updateMap);
        document.getElementById('distanceFilter').addEventListener('input', updateMap);
        document.getElementById('searchInput').addEventListener('input', updateMap);
        document.getElementById('locationInput').addEventListener('input', updateMap);
      });

    function createLetterMarker(user) {
      const firstLetter = user['First Name'] ? user['First Name'][0].toUpperCase() : '?';
      return L.divIcon({ html: `<div class="letter-marker">${firstLetter}</div>`, className: '', iconSize: [30, 30], iconAnchor: [15, 15] });
    }

    function updateMap() {
      markerCluster.clearLayers();
      markers = [];
      selectedMarker = null;
      const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
      const nameFilter = document.getElementById('searchInput').value.toLowerCase();
      const locationFilter = document.getElementById('locationInput').value.toLowerCase();

      allData.forEach(row => {
        if (typeFilter && row['Type'].toLowerCase() !== typeFilter) return;
        if (nameFilter && !(`${row['First Name']} ${row['Last Name']}`.toLowerCase().includes(nameFilter))) return;
        if (locationFilter && row['City'] && !row['City'].toLowerCase().includes(locationFilter)) return;

        if (!row['Geocode'] || !row['Geocode'].includes(',')) return;
        const [lat, lng] = row['Geocode'].split(',').map(Number);
        if (isNaN(lat) || isNaN(lng)) return;

        const marker = L.marker([lat, lng], { icon: createLetterMarker(row) });
        marker.data = row;

        marker.on('click', () => handleMarkerClick(marker));
        marker.on('mouseover', () => highlightCard(marker, true));
        marker.on('mouseout', () => highlightCard(marker, false));

        markers.push(marker);
        markerCluster.addLayer(marker);
      });
    }

    function handleMarkerClick(marker) {
      selectedMarker = marker;
      const radiusKm = parseFloat(document.getElementById('distanceFilter').value) || 50;
      const nearby = markers.filter(m => m !== marker && haversineDistance(marker.getLatLng(), m.getLatLng()) <= radiusKm);

      const listDiv = document.getElementById('nearbyList');
      listDiv.innerHTML = '';

      // Selected marker first
      const divSel = document.createElement('div');
      divSel.className = 'nearby-entry';
      divSel.dataset.markerId = getMarkerId(marker);
      divSel.innerHTML = `<div class="name-distance"><span>${marker.data['First Name']} ${marker.data['Last Name']} (Selected)</span><span class="distance">0 km</span></div>
                          <div class="company-name">${marker.data['Business Name'] || ''}</div>`;
      divSel.addEventListener('mouseenter', () => marker.getElement().style.filter='drop-shadow(0 0 12px #00f)');
      divSel.addEventListener('mouseleave', () => marker.getElement().style.filter='drop-shadow(0 0 0 rgba(0,0,0,0))');
      listDiv.appendChild(divSel);

      nearby.forEach(m => {
        const dist = haversineDistance(marker.getLatLng(), m.getLatLng()).toFixed(1);
        const div = document.createElement('div');
        div.className = 'nearby-entry';
        div.dataset.markerId = getMarkerId(m);
        div.innerHTML = `<div class="name-distance"><span>${m.data['First Name']} ${m.data['Last Name']}</span><span class="distance">${dist} km</span></div>
                         <div class="company-name">${m.data['Business Name'] || ''}</div>`;
        div.addEventListener('mouseenter', () => m.getElement().style.filter='drop-shadow(0 0 12px #00f)');
        div.addEventListener('mouseleave', () => m.getElement().style.filter='drop-shadow(0 0 0 rgba(0,0,0,0))');
        listDiv.appendChild(div);
      });
    }

    function highlightCard(marker, hover) {
      const card = document.querySelector(`[data-marker-id="${getMarkerId(marker)}"]`);
      if(card) card.style.backgroundColor = hover ? 'rgba(255,255,255,0.2)' : 'transparent';
    }

    function getMarkerId(marker) {
      const d = marker.data;
      return `${d['First Name']}_${d['Last Name']}_${d['Business Name'] || ''}`.replace(/\s+/g,'_');
    }

    function haversineDistance(latlng1, latlng2) {
      const R = 6371;
      const dLat = (latlng2.lat - latlng1.lat) * Math.PI / 180;
      const dLon = (latlng2.lng - latlng1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(latlng1.lat*Math.PI/180) * Math.cos(latlng2.lat*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
  </script>
</body>
</html>
