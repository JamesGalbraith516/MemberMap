<script>
  const map = L.map('map').setView([-37.8, 144.95], 6); // Start over Melbourne

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSm2djr9eOyF8SI92KcfrCsrFEcW3dmaStUT4H0Ard8A1BUKKgd08owmHvG6TT7AdfPXB26pJ-Stzjw/pub?output=csv&gid=528897676';

  fetch(sheetURL)
    .then(response => response.text())
    .then(csv => {
      const rows = csv.trim().split('\n');
      const headers = rows[0].split(',');

      // Find column indexes
      const geocodeIndex = headers.indexOf('Geocode');
      const nameIndex = headers.indexOf('First Name');
      const lastIndex = headers.indexOf('Last Name');
      const bizIndex = headers.indexOf('Business Name');
      const typeIndex = headers.indexOf('Membership');

      rows.slice(1).forEach(row => {
        const columns = row.split(',');

        const geocode = columns[geocodeIndex];
        if (!geocode || !geocode.includes(',')) return;

        const [lat, lng] = geocode.split(',').map(Number);
        if (isNaN(lat) || isNaN(lng)) return;

        const name = columns[nameIndex] || '';
        const last = columns[lastIndex] || '';
        const biz = columns[bizIndex] || '';
        const type = columns[typeIndex] || '';

        const popup = `
          <strong>${name} ${last}</strong><br>
          ${biz}<br>
          <em>${type}</em>
        `;

        L.marker([lat, lng]).bindPopup(popup).addTo(map);
      });
    })
    .catch(error => console.error('Error loading CSV:', error));
</script>
