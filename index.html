<script>
(function() {
    const sidePanel = document.getElementById('sidePanel');
    const collapseButton = document.getElementById('collapseButton');

    // Initialize map without zoom controls
    const map = L.map('map', { zoomControl: false }).setView([50.5, -95.0], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let sheetURL = 'https://docs.google.com/spreadsheets/d/17h6qtv7Kw3ejYyK0hv7XyTUQ1y7KP3wj_w-pG4yNfkM/edit?gid=1454020769#gid=1454020769&single=true&output=csv';

    let markers = [];
    let allData = [];
    let radiusCircle = null;
    let selectedMarker = null;

    const blueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    const yellowIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    const greyIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // Load CSV and populate map and filters
    fetch(sheetURL)
        .then(response => response.text())
        .then(csv => {
            const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
            allData = parsed.data;

            // Fill type filter dropdown
            const typeSet = new Set();
            allData.forEach(row => {
                const geocode = row['Geocode'];
                if (!geocode || !geocode.includes(',')) return;
                typeSet.add(row['Type']);
            });

            const typeSelect = document.getElementById('typeFilter');
            Array.from(typeSet).sort().forEach(type => {
                const opt = document.createElement('option');
                opt.value = type;
                opt.textContent = type;
                typeSelect.appendChild(opt);
            });

            updateMap();

            typeSelect.addEventListener('change', updateMap);
            document.getElementById('distanceFilter').addEventListener('input', updateMap);
            document.getElementById('downloadCsvBtn').addEventListener('click', downloadResults);
        });

    // Toggle sidebar collapse
    collapseButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isCurrentlyCollapsed = sidePanel.classList.contains('collapsed');

        if (isCurrentlyCollapsed) {
            collapseButton.style.left = '300px';
            setTimeout(() => {
                sidePanel.classList.remove('collapsed');
                collapseButton.innerHTML = '&#x276E;';
            }, 150);
        } else {
            sidePanel.classList.add('collapsed');
            collapseButton.innerHTML = '&#x276F;';
            setTimeout(() => {
                collapseButton.style.left = '20px';
            }, 150);
        }
    });

    function updateMap() {
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        if (radiusCircle) {
            map.removeLayer(radiusCircle);
            radiusCircle = null;
        }

        selectedMarker = null;
        updateMarkerCount(0);
        resetAllMarkerIcons();

        const typeFilter = document.getElementById('typeFilter').value;

        allData.forEach(row => {
            if (typeFilter && row['Type'] !== typeFilter) return;

            const geocode = row['Geocode'];
            if (!geocode || !geocode.includes(',')) return;

            const [lat, lng] = geocode.split(',').map(Number);
            if (isNaN(lat) || isNaN(lng)) return;

            const marker = L.marker([lat, lng], { icon: greyIcon });
            marker.data = row;

            marker.on('click', function () {
                resetAllMarkerIcons();

                if (radiusCircle) {
                    map.removeLayer(radiusCircle);
                    radiusCircle = null;
                }

                selectedMarker = marker;

                let radiusKm = parseFloat(document.getElementById('distanceFilter').value);
                if (isNaN(radiusKm) || radiusKm <= 0) radiusKm = 50;

                const selectedLatLng = marker.getLatLng();
                let nearby = findNearbyMarkers(marker, radiusKm);

                nearby = nearby.map(m => ({
                    marker: m,
                    distance: haversineDistance(selectedLatLng, m.getLatLng())
                }));
                nearby.sort((a, b) => a.distance - b.distance);

                nearby.forEach(entry => entry.marker.setIcon(blueIcon));
                marker.setIcon(yellowIcon);

                radiusCircle = L.circle(marker.getLatLng(), {
                    radius: radiusKm * 1000,
                    color: '#999',
                    fillColor: '#ccc',
                    fillOpacity: 0.15,
                    weight: 1
                }).addTo(map);

                const listDiv = document.getElementById('nearbyList');
                listDiv.innerHTML = '';

                const d = marker.data;
                const divSelected = document.createElement('div');
                divSelected.className = 'nearby-entry';
                divSelected.setAttribute('data-marker-id', getMarkerId(marker));
                divSelected.innerHTML = `
                    <div class="name-distance">
                        <span>${d['First Name']} ${d['Last Name']} (Selected)</span>
                        <span class="distance">0.0 km</span>
                    </div>
                    <div class="company-name">${d['Business Name']}</div>
                `;
                divSelected.addEventListener('mouseenter', () => {
                    marker.getElement().style.filter = 'drop-shadow(0 0 12px #ffff00)';
                });
                divSelected.addEventListener('mouseleave', () => {
                    marker.getElement().style.filter = 'drop-shadow(0 0 0 rgba(0,0,0,0))';
                });
                listDiv.appendChild(divSelected);

                if (nearby.length === 0) {
                    const noDiv = document.createElement('div');
                    noDiv.textContent = 'No nearby markers found.';
                    listDiv.appendChild(noDiv);
                } else {
                    nearby.forEach(entry => {
                        const d = entry.marker.data;
                        const distance = entry.distance.toFixed(1);
                        const div = document.createElement('div');
                        div.className = 'nearby-entry';
                        div.setAttribute('data-marker-id', getMarkerId(entry.marker));
                        div.innerHTML = `
                            <div class="name-distance">
                                <span>${d['First Name']} ${d['Last Name']}</span>
                                <span class="distance">${distance} km</span>
                            </div>
                            <div class="company-name">${d['Business Name']}</div>
                        `;
                        div.addEventListener('mouseenter', () => {
                            entry.marker.getElement().style.filter = 'drop-shadow(0 0 12px #0066ff)';
                            div.style.backgroundColor = 'rgba(255,255,255,0.1)';
                        });
                        div.addEventListener('mouseleave', () => {
                            entry.marker.getElement().style.filter = 'drop-shadow(0 0 0 rgba(0,0,0,0))';
                            div.style.backgroundColor = 'transparent';
                        });
                        listDiv.appendChild(div);
                    });
                }

                marker._nearbyMarkers = nearby;
                updateMarkerCount(nearby.length);

                const popupHTML = `
                    <strong>${marker.data['First Name']} ${marker.data['Last Name']}</strong><br>
                    ${marker.data['Business Name']}<br><br>
                    <strong>${nearby.length} nearby markers within ${radiusKm} km</strong>
                `;
                marker.bindPopup(popupHTML).openPopup();
            });

            marker.on('mouseover', function() {
                if (selectedMarker) {
                    const markerId = getMarkerId(marker);
                    const correspondingEntry = document.querySelector(`[data-marker-id="${markerId}"]`);
                    if (correspondingEntry) {
                        correspondingEntry.style.backgroundColor = 'rgba(255,255,255,0.2)';
                        correspondingEntry.style.transform = 'translateX(5px)';
                    }
                }
            });

            marker.on('mouseout', function() {
                if (selectedMarker) {
                    const markerId = getMarkerId(marker);
                    const correspondingEntry = document.querySelector(`[data-marker-id="${markerId}"]`);
                    if (correspondingEntry) {
                        correspondingEntry.style.backgroundColor = 'transparent';
                        correspondingEntry.style.transform = 'translateX(0)';
                    }
                }
            });

            marker.addTo(map);
            markers.push(marker);
        });
    }

    function resetAllMarkerIcons() {
        markers.forEach(m => m.setIcon(greyIcon));
    }

    function getMarkerId(marker) {
        const data = marker.data;
        return `${data['First Name']}_${data['Last Name']}_${data['Business Name']}`.replace(/\s+/g, '_');
    }

    function updateMarkerCount(count) {
        const countDiv = document.getElementById('markerCount');
        if (count === 0) {
            countDiv.textContent = 'No marker selected';
        } else {
            countDiv.textContent = `Total nearby markers: ${count}`;
        }
    }

    function haversineDistance(latlng1, latlng2) {
        const R = 6371;
        const dLat = (latlng2.lat - latlng1.lat) * Math.PI / 180;
        const dLon = (latlng2.lng - latlng1.lng) * Math.PI / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(latlng1.lat * Math.PI / 180) * Math.cos(latlng2.lat * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function findNearbyMarkers(clickedMarker, radiusKm) {
        const nearby = [];
        const clickedLatLng = clickedMarker.getLatLng();

        markers.forEach(marker => {
            if (marker === clickedMarker) return;
            const dist = haversineDistance(clickedLatLng, marker.getLatLng());
            if (dist <= radiusKm) nearby.push(marker);
        });

        return nearby;
    }

    function downloadResults() {
        if (!selectedMarker) {
            showErrorModal('No Results', 'Please select a marker first to download nearby results.');
            return;
        }

        const radiusKm = parseFloat(document.getElementById('distanceFilter').value) || 50;
        const selectedLatLng = selectedMarker.getLatLng();
        let nearby = findNearbyMarkers(selectedMarker, radiusKm);

        nearby = nearby.map(m => ({
            marker: m,
            distance: haversineDistance(selectedLatLng, m.getLatLng())
        }));
        nearby.sort((a, b) => a.distance - b.distance);

        const csvMarkers = [selectedMarker, ...nearby.map(entry => entry.marker)];

        const allKeysSet = new Set();
        csvMarkers.forEach(marker => Object.keys(marker.data).forEach(k => allKeysSet.add(k)));
        const allKeys = Array.from(allKeysSet);
        if (!allKeys.includes('Distance (km)')) allKeys.push('Distance (km)');

        const csvData = csvMarkers.map((marker, index) => {
            const row = {};
            allKeys.forEach(k => {
                if (k === 'Distance (km)') {
                    row[k] = index === 0 ? '0.0' : nearby[index - 1].distance.toFixed(1);
                } else {
                    row[k] = marker.data[k] || '';
                }
            });
            return row;
        });

        const csv = Papa.unparse(csvData);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'nearby_results.csv';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }

    function showErrorModal(title, message) {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;

        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        `;

        const titleEl = document.createElement('h3');
        titleEl.textContent = title;
        titleEl.style.cssText = `margin: 0 0 16px 0; color: #333; font-size: 18px;`;

        const messageEl = document.createElement('p');
        messageEl.textContent = message;
        messageEl.style.cssText = `margin: 0 0 20px 0; color: #666; font-size: 14px; line-height: 1.4;`;

        const okButton = document.createElement('button');
        okButton.textContent = 'OK';
        okButton.style.cssText = `
            background: #007ACC;
            color: white;
            border: none;
            padding: 8px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        `;

        okButton.addEventListener('click', () => { document.body.removeChild(overlay); });
        okButton.addEventListener('mouseenter', () => { okButton.style.background = '#005a9e'; });
        okButton.addEventListener('mouseleave', () => { okButton.style.background = '#007ACC'; });

        modal.appendChild(titleEl);
        modal.appendChild(messageEl);
        modal.appendChild(okButton);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) document.body.removeChild(overlay);
        });
    }
})();
</script>
