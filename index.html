<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Member Map with Collapsible Sidebar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
    }

    #container {
      display: flex;
      height: 100%;
      width: 100%;
      position: relative;
    }

    #map {
      flex: 1;
      z-index: 1;
      position: relative;
    }

    #sidePanel {
      width: 300px;
      transition: width 0.3s ease;
      background-color: #0094cd;
      color: white;
      overflow-y: auto;
      padding: 1rem;
      box-sizing: border-box;
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
    }

    #sidePanel.collapsed {
      width: 20px;
      padding: 0;
      overflow: hidden;
    }

    #sidebarToggle {
      position: absolute;
      top: 50%;
      left: 300px;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      background: white;
      color: #0094cd;
      border: 2px solid #0094cd;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      transition: left 0.3s ease;
      z-index: 3;
    }

    #sidePanel.collapsed + #sidebarToggle {
      left: 20px;
    }

    #markerCount {
      font-weight: bold;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }

    #nearbyList {
      flex: 1;
      font-size: 0.85rem;
      overflow-y: auto;
      color: white;
      margin-top: 0.5rem;
    }

    .nearby-entry {
      padding: 0.4rem 0.2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      white-space: nowrap;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
    }

    .nearby-entry:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    .nearby-entry .distance {
      font-weight: normal;
      font-size: 0.75rem;
      opacity: 0.8;
      min-width: 50px;
      text-align: right;
    }

    .glowing-marker {
      filter: drop-shadow(0 0 5px #00caff) drop-shadow(0 0 10px #00caff);
      z-index: 1000 !important;
      transition: filter 0.3s ease;
    }

    /* Override Leaflet zoom control position and transition */
    .leaflet-control-zoom {
      left: 310px !important;
      transition: left 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidePanel">
      <div id="markerCount">No marker selected</div>
      <div id="nearbyList">Click a marker to see nearby entries.</div>
    </div>

    <div id="sidebarToggle">&#x276E;</div>

    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const sheetURL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm2djr9eOyF8SI92KcfrCsrFEcW3dmaStUT4H0Ard8A1BUKKgd08owmHvG6TT7AdfPXB26pJ-Stzjw/pub?gid=528897676&single=true&output=csv";

    const map = L.map("map", { zoomControl: false }).setView([50.5, -95.0], 4);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // Add zoom control manually (to control left position)
    const zoomControl = L.control.zoom({ position: "topleft" }).addTo(map);

    function updateZoomControlPosition(isCollapsed) {
      const zoomEl = document.querySelector(".leaflet-control-zoom");
      if (!zoomEl) return;
      zoomEl.style.left = isCollapsed ? "30px" : "310px";
    }

    updateZoomControlPosition(false);

    let markers = [];
    let allData = [];
    let selectedMarker = null;

    const sidePanel = document.getElementById("sidePanel");
    const sidebarToggle = document.getElementById("sidebarToggle");
    const nearbyList = document.getElementById("nearbyList");
    const markerCount = document.getElementById("markerCount");

    // Load and parse CSV from Google Sheets
    fetch(sheetURL)
      .then((res) => res.text())
      .then((csv) => {
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        allData = parsed.data;

        // Create markers
        allData.forEach((row, i) => {
          const geocode = row["Geocode"];
          if (!geocode || !geocode.includes(",")) return;

          const [lat, lng] = geocode.split(",").map(Number);
          if (isNaN(lat) || isNaN(lng)) return;

          const marker = L.marker([lat, lng]);
          marker.data = row;

          marker.on("click", () => {
            if (selectedMarker) resetMarkerIcon(selectedMarker);
            selectedMarker = marker;

            highlightMarker(marker);
            showNearby(marker);
          });

          marker.addTo(map);
          markers.push(marker);
        });
      });

    function resetMarkerIcon(marker) {
      if (marker && marker._icon) {
        marker._icon.classList.remove("glowing-marker");
      }
    }

    function highlightMarker(marker) {
      if (marker && marker._icon) {
        marker._icon.classList.add("glowing-marker");
      }
    }

    function haversineDistance(latlng1, latlng2) {
      const R = 6371; // km
      const dLat = ((latlng2.lat - latlng1.lat) * Math.PI) / 180;
      const dLon = ((latlng2.lng - latlng1.lng) * Math.PI) / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos((latlng1.lat * Math.PI) / 180) *
          Math.cos((latlng2.lat * Math.PI) / 180) *
          Math.sin(dLon / 2) *
          Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function showNearby(marker) {
      const radiusKm = 50; // fixed radius, could be dynamic if you want

      const selectedLatLng = marker.getLatLng();

      const nearbyMarkers = markers
        .filter((m) => m !== marker)
        .map((m) => {
          return {
            marker: m,
            distance: haversineDistance(selectedLatLng, m.getLatLng()),
          };
        })
        .filter((m) => m.distance <= radiusKm)
        .sort((a, b) => a.distance - b.distance);

      // Clear previous highlights
      markers.forEach((m) => resetMarkerIcon(m));

      // Highlight selected marker & nearby markers
      highlightMarker(marker);
      nearbyMarkers.forEach((entry) => highlightMarker(entry.marker));

      // Update nearby list
      nearbyList.innerHTML = "";

      // Selected marker on top
      const d = marker.data;
      const selectedDiv = document.createElement("div");
      selectedDiv.className = "nearby-entry";
      selectedDiv.style.fontWeight = "bold";
      selectedDiv.textContent = `${d["First Name"]} ${d["Last Name"]} (Selected)`;
      nearbyList.appendChild(selectedDiv);

      // Nearby entries
      if (nearbyMarkers.length === 0) {
        const noNearby = document.createElement("div");
        noNearby.textContent = "No nearby markers found.";
        nearbyList.appendChild(noNearby);
      } else {
        nearbyMarkers.forEach(({ marker: m, distance }) => {
          const d = m.data;
          const div = document.createElement("div");
          div.className = "nearby-entry";
          div.textContent = `${d["First Name"]} ${d["Last Name"]}`;

          const distSpan = document.createElement("span");
          distSpan.className = "distance";
          distSpan.textContent = `${distance.toFixed(1)} km`;

          div.appendChild(distSpan);
          nearbyList.appendChild(div);
        });
      }

      markerCount.textContent = `Total nearby markers: ${nearbyMarkers.length}`;
    }

    // Glow marker on hover from nearby list
    nearbyList.addEventListener("mouseover", (e) => {
      const entry = e.target.closest(".nearby-entry");
      if (!entry) return;

      const text = entry.textContent.replace("(Selected)", "").trim();

      const foundMarker = markers.find((m) => {
        const d = m.data;
        if (!d) return false;
        const fullName = `${d["First Name"]} ${d["Last Name"]}`;
        return fullName === text;
      });

      if (foundMarker && foundMarker._icon) {
        foundMarker._icon.classList.add("glowing-marker");
      }
    });

    nearbyList.addEventListener("mouseout", (e) => {
      const entry = e.target.closest(".nearby-entry");
      if (!entry) return;

      const text = entry.textContent.replace("(Selected)", "").trim();

      const foundMarker = markers.find((m) => {
        const d = m.data;
        if (!d) return false;
        const fullName = `${d["First Name"]} ${d["Last Name"]}`;
        return fullName === text;
      });

      if (foundMarker && foundMarker._icon) {
        foundMarker._icon.classList.remove("glowing-marker");
      }
    });

    // Sidebar toggle logic
    sidebarToggle.addEventListener("click", () => {
      const isCollapsed = sidePanel.classList.toggle("collapsed");
      sidebarToggle.innerHTML = isCollapsed ? "&#x276F;" : "&#x276E;"; // ❯ or ❮
      updateZoomControlPosition(isCollapsed);
    });
  </script>
</body>
</html>
